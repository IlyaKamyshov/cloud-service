# Дипломная работа «Облачное хранилище»
## Описание проекта

Данное приложение (REST-сервис) предоставляет интерфейс для загрузки файлов и вывода списка уже загруженных файлов пользователя по заранее описанной спецификации.

Заранее подготовленное веб-приложение (FRONT) подключается к разработанному сервису (BACK) без доработок и использует его функционал. Все запросы к сервису авторизованы.

## Выполненные ребования к приложению

* Сервис предоставляет REST-интерфейс для интеграции с [FRONT](https://github.com/netology-code/jd-homeworks/tree/master/diploma/netology-diplom-frontend).
* Сервис должен реализовывать все методы, описанные [в протоколе](https://github.com/netology-code/jd-homeworks/blob/master/diploma/CloudServiceSpecification.yaml):
  * вывод списка файлов,
  * добавление файла,
  * удаление файла,
  * авторизация.
* Все настройки должны вычитываться из файла настроек application.properties.
* Информация о пользователях сервиса (логины для авторизации) и данные должны храниться в базе данных (на выбор студента).

## Описание реализации

* Приложение разработано с использованием Spring Boot.
* Использован сборщик пакетов Maven.
* Применяется СУБД MariaDB.
* Для миграции схемы данных используется Liquibase.
* Безопасность осуществляется с использованием Spring Security и кастомным сервисом генерации токенов.
* Логирование осуществляется кастомным логгером.
* Для запуска используется Docker, Docker Compose.
* Код размещён на GitHub.
* Приложение протестировано с помощью функционала HTTP Client в IJ IDEA.
* Приложение протестировано с помощью юнит-тестов JUnit 5 / Mockito.
* Приложение протестировано с помощью Testcontainers.

## Архитектура приложения

Многослойная модель приложения:

* ```Controller```
  * AuthenticationController используется для идентификации и аутентификации клиента (FRONT) по логину и паролю, и в случае успешной проверки в ответ возвращает json-объект с auth-token. Все дальнейшие запросы клиента отправляются с этим заголовком.
  * FileController используется для доступа к работе с файлами авторизованному клиенту (FRONT).

* ```Service```
  * CustomUserDetailsService используется для извлечения пользователя из базы данных.
  * CustomLogoutHandler используется для обработки запроса клиента (FRONT) на выход, во время которой аннулируется auth-token.
  * FileService используется для загрузки, удаления, изменения и чтения файлов из хранилища файлов.
  * TokenService используется для генерации токенов auth-token, сохранения/удаления auth-token в/из TokenRepository.

* ```Repository```
  * UserRepository используется для поиска пользователей в базе данных.
  * TokenRepository используется для хранения токенов auth-token и представляет собой im-memory базу данных.
  * FileRepository используется для поиска в базе данных информации о файлах, загруженных в хранилище файлов.

* ```Config```
  * TokenFilter используется для проверки auth-token при каждом запросе.
  * SecurityConfig используется для настройки аутентификации и авторизации.

* ```Entity```
  * UserEntity используется для соотнесения с таблицей users в базе данных.
  * FileEntity используется для соотнесения с таблицей files в базе данных.

* ```DTO```
  * FileInfoDTO используется для ответа клиенту (FRONT) при запросе списка файлов.
  * FileRenameDTO используется для запроса при переименовании файла клиентом (FRONT).
  * LoginRequestDTO используется для запроса при идентификации и аутентификации клиента (FRONT).
  * LoginResponseDTO используется для ответа клиенту (FRONT) в случае успешной проверки.

* ```Exception```
  * ExceptionHandlerAdvice используется для централизованной обработки исключений.
  * InvalidCredentialsException используется для выбрасывания исключения при передаче невернхы учетных данных от клиента (FRONT) при идентификации и аутентификации.
  * InvalidInputDataException используется для выбрасывания исключения при передачи неверных данных о файле от клиента (FRONT).

* ```Logger```
  * CloudServiceLogger используется для автоматической регистрации ошибок и действий пользователей.

* ```Util```
  * CustomFileUtil используется сервисом FileService непосредственно для для загрузки, удаления, изменения и чтения файлов из хранилища файлов.

## Функционал приложения

* POST ```/login``` - принимает запрос на идентификацию и аутентификацию клиента (FRONT). При успешной проверке возвращает json-объект с auth-token, который используется в заголовке для авторизации клиента (FRONT) в сервисе (BACK) при всех дальнейших запросах.

  Выполняемые проверки:
    * Значение login не может быть пустым.
    * Значение login не может быть null.
    * Значение password не может быть пустым.
    * Значение password не может быть null.

###

* POST ```/logout``` - принимает запрос на выход. Происходит аннулирование токена auth-token.

  Выполняемые проверки:
    * Клиент (FRONT) авторизован.

###

* GET ```/list``` - принимает в параметре лимит файлов для отображения. Отправляет клиенту (FRONT) ответ со списком файлов пользователя.

  Выполняемые проверки:
    * Клиент (FRONT) авторизован.

###

* POST ```/file``` - принимает запрос в формате multipart/form-data. Сохраняет переданный файл в хранилище и данные о файле в базу данных.

  Выполняемые проверки:
    * Клиент (FRONT) авторизован.
    * Файл присутствует в запросе.
    * Файл с таким именем не загружен в хранилище.
  
###

* DELETE ```/file``` - принимает в параметре имя файла. Удаляет файл из хранилища и данные о файле из базы данных.

  Выполняемые проверки:
    * Клиент (FRONT) авторизован.
    * Файл с таким именем загружен в хранилище.

###

* GET ```/file``` - принимает в параметре имя файла. Отправляет клиенту (FRONT) ответ с файлом в формате multipart/form-data.

  Выполняемые проверки:
    * Клиент (FRONT) авторизован.
    * Файл с таким именем загружен в хранилище.

###

* PUT ```/file``` - принимает в параметре имя файла и в теле запроса новое имя файла. Изменяет данные о файле в базе данных.

  Выполняемые проверки:
    * Клиент (FRONT) авторизован.
    * Файл с таким именем загружен в хранилище.

###

При несоблюдении какой-либо из описанных выше проверок выбрасывается исключение и клиенту возвращается ответ с id ошибки и сообщением об ошибке.


## Запуск приложения

В первую очередь необходимо создать артефакт JAR в IntelliJ IDEA: в окне инструмента ```Maven``` в списке ```Lifecycle``` дважды кликнуть по ```pakage```.

Затем в терминале в корневой директории проекта следует ввести команду: ```docker-compose up```.

В итоге запустятся два docker-контейнера:
* REST-сервис CloudService на TCP-порту 8080.
* СУБД MariaDB на TCP-порту 3306.

Далее можно запускать клиента (FRONT), предварительно изменив в файле .env URL до REST-сервиса (BACK) на ```VUE_APP_BASE_URL=http://localhost:8080```.

Учетные данные для входа:
* user : password
* admin : passw0rd